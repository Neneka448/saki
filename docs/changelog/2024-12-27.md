# Changelog - 2024-12-27

## 新增功能

### 1. 项目管理模块

- **Project 实体**: 新增 `Project` 实体，支持知识库隔离
  - 字段: `id`, `name`, `description`, `icon`, `color`, `createdAt`, `updatedAt`
  - 位置: `src/kernel/domain/entities/Project.ts`

- **项目仓储接口**: `IProjectRepository`
  - 位置: `src/kernel/domain/repositories/IProjectRepository.ts`

- **项目服务**: `ProjectService`
  - CRUD 操作: create, getById, getAll, update, delete
  - 位置: `src/kernel/domain/services/ProjectService.ts`

- **Drizzle 实现**: `DrizzleProjectRepository`
  - 位置: `src/kernel/infrastructure/persistence/repositories/DrizzleProjectRepository.ts`

- **项目 API**: `ProjectApi`
  - 位置: `src/kernel/api/ProjectApi.ts`

### 2. 项目选择页面

- **ProjectSelector 组件**: 应用启动时显示项目选择页面
  - 左侧: Logo + 创建知识库按钮
  - 右侧: 已有知识库列表
  - 支持创建新项目对话框
  - 位置: `src/renderer/src/components/ProjectSelector.vue`

- **返回项目选择**: ChatPanel 左上角添加返回按钮，可返回知识库选择页

### 3. 数据隔离

- **Card 关联项目**: 卡片添加 `projectId` 字段
  - 新增 `getListByProject(projectId)` 方法
  - 新增 `countByProject(projectId)` 方法
  - 新增 `deleteByProject(projectId)` 方法

- **Tag 关联项目**: 标签添加 `projectId` 字段
  - 查询方法增加 `projectId` 参数
  - 新增 `deleteByProject(projectId)` 方法

### 4. 资源协议

- **asset:// 协议**: 注册自定义协议加载本地资源
  - 在主进程注册 `protocol.handle('asset', ...)`
  - 支持加载 `.runtime/assets/` 目录下的图片
  - 支持 MIME 类型: png, jpg, jpeg, gif, webp, svg, pdf
  - 位置: `src/main/index.ts`

## 修改

### 数据库 Schema

- `projects` 表: 新增项目表
- `cards` 表: 添加 `project_id` 外键
- `tags` 表: 添加 `project_id` 外键
- 位置: `src/kernel/infrastructure/persistence/schema.ts`

### IPC 通信

- **channels.ts**: 新增 `project` 相关 channels
- **types.ts**: 新增 `Project` 类型，更新 `CreateCardParams` 和 `CreateTagParams`
- **projectHandlers.ts**: 项目 IPC handlers
- **cardHandlers.ts**: 更新以支持 projectId
- **tagHandlers.ts**: 更新以支持 projectId

### Preload Bridge

- **projectBridge.ts**: 暴露项目 API 给渲染进程
- **cardBridge.ts**: 新增 `getListByProject(projectId)` 方法
- **tagBridge.ts**: 更新方法签名

### 前端组件

- **App.vue**: 条件渲染项目选择器或主界面
- **WorkspacePanel.vue**: 接收 `projectId` prop
- **CardEditView.vue**: 接收 `projectId` prop
- **MarkdownRenderer.vue**: 简化，直接使用 asset:// 协议

## 测试

- 所有 152 个测试通过
- 更新了 mock 以支持新的 API 签名
- 更新了组件测试以传递必要的 props

## 技术细节

### 协议注册

```typescript
// 必须在 app.whenReady() 之前注册
protocol.registerSchemesAsPrivileged([
  {
    scheme: 'asset',
    privileges: {
      secure: true,
      supportFetchAPI: true,
      bypassCSP: true,
      stream: true,
    },
  },
])
```

### 项目隔离架构

```
App.vue
├── ProjectSelector.vue (未选择项目时)
└── app-layout (选择项目后)
    ├── ChatPanel.vue
    └── WorkspacePanel.vue (接收 projectId)
        └── CardEditView.vue (接收 projectId)
```
